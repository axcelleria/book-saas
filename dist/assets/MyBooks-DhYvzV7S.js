import{u as C,j as e,A as p}from"./index-DmeS5GNz.js";import{b as i,L as h}from"./vendor-7WqT3uju.js";import{c as k}from"./bookService-Bs2BJIUy.js";import{M as n}from"./materialize-B2tdm-kr.js";import"./ui-D2T_FE5F.js";const $=()=>{const{user:l}=C(),[a,u]=i.useState([]),[f,m]=i.useState(!1),[x,b]=i.useState(""),[w,d]=i.useState([]),j=i.useRef(!1);i.useEffect(()=>{l&&(async()=>{try{m(!0);const s=await k(l.id);u(s),d(s)}catch(s){n.toast({html:s.message})}finally{m(!1)}})()},[l]),i.useEffect(()=>{d(a.filter(t=>t.title.toLowerCase().includes(x.toLowerCase()))),n.Tooltip.init(document.querySelectorAll(".tooltipped"))},[x,a]);const y=async t=>{if(window.confirm("Are you sure you want to delete this book?"))try{if((await fetch(`${p}/books/${t}`,{method:"DELETE"})).ok){const r=a.filter(o=>o.id!==t);u(r),d(r),n.toast({html:"Book deleted successfully"})}else throw new Error("Failed to delete book")}catch(s){n.toast({html:"Error deleting book"}),console.error("Error:",s)}},g=async t=>{try{const s=await fetch(`${p}/subscribers/export/${t}`,{method:"GET",headers:{Authorization:`Bearer ${l.token}`}});if(!s.ok)throw new Error("Failed to export subscribers");const r=await s.blob(),o=window.URL.createObjectURL(r),c=document.createElement("a");c.href=o,c.download=`subscribers_${t}.csv`,document.body.appendChild(c),c.click(),c.remove()}catch(s){n.toast({html:`Error: ${s.message}`})}},v=t=>{g(t)},N=t=>t.toLowerCase().replace(/[^\w\s]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-"),E=async t=>{try{const s=await fetch(`${p}/subscribers/count/${t}`);if(!s.ok)throw new Error("Failed to fetch subscriber count");const{count:r}=await s.json();return r}catch(s){return console.error("Error fetching subscriber count:",s),0}};return i.useEffect(()=>{if(j.current)return;const t=async()=>{try{const s=await Promise.all(a.map(async r=>{const o=await E(r.id);return{...r,subscriberCount:o}}));u(s),d(s),j.current=!0}catch(s){console.error("Error updating subscriber counts:",s)}};a.length>0&&t()},[a]),f?e.jsx("div",{className:"center-align",children:"Loading..."}):a.length===0?e.jsx("div",{className:"container center-align",style:{marginTop:"50px"},children:e.jsxs("div",{className:"card-panel blue lighten-5",children:[e.jsx("i",{className:"material-icons large",children:"menu_book"}),e.jsx("h4",{children:"No Books Added Yet"}),e.jsx("p",{children:"Start your book collection by adding your first book!"}),e.jsxs(h,{to:"/add",className:"btn-large waves-effect waves-light blue",style:{marginTop:"20px"},children:[e.jsx("i",{className:"material-icons left",children:"add"}),"Add Your First Book"]})]})}):e.jsxs("div",{className:"container",children:[e.jsx("div",{className:"row",children:e.jsx("div",{className:"col s12",children:e.jsxs("h2",{children:[l.full_name,"'s Bookshelf"]})})}),e.jsx("div",{className:"row",children:e.jsxs("div",{className:"input-field col s12",children:[e.jsx("i",{className:"material-icons prefix",children:"search"}),e.jsx("input",{id:"titleFilter",type:"text",value:x,onChange:t=>b(t.target.value)}),e.jsx("label",{htmlFor:"titleFilter",children:"Filter by Title"})]})}),e.jsxs("table",{className:"striped responsive-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Cover"}),e.jsx("th",{children:"Title"}),e.jsx("th",{children:"Author"}),e.jsx("th",{children:"Category"}),e.jsx("th",{children:"Tags"}),e.jsx("th",{style:{width:"100px"},children:"Status"}),e.jsxs("th",{style:{width:"55px"},children:[" ",e.jsx("i",{className:"material-icons tiny",children:"visibility"})," "]}),e.jsxs("th",{style:{width:"55px"},children:[" ",e.jsx("i",{className:"material-icons tiny",children:"file_download"})," "]}),e.jsx("th",{style:{width:"55px"},children:e.jsx("i",{className:"material-icons tiny",children:"rss_feed"})}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:w.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("img",{src:t.cover||"https://placehold.co/50x70",alt:t.title,style:{width:"50px",height:"70px",objectFit:"cover"}})}),e.jsx("td",{children:e.jsx(h,{to:`/book/${N(t.title)}`,children:t.title})}),e.jsx("td",{children:t.author}),e.jsx("td",{children:e.jsx("span",{className:"chip teal white-text",children:t.category||"Uncategorized"})}),e.jsx("td",{style:{width:"200px"},children:t.tags&&t.tags.split(",").map(s=>e.jsx("span",{className:"chip",children:s.trim()},s))}),e.jsx("td",{children:e.jsx("span",{className:`btn-small ${t.book_status===1?"green":"orange"}`,style:{cursor:"default"},children:e.jsx("i",{className:"material-icons tooltipped","data-position":"top","data-tooltip":t.book_status===1?"Public":"Paused",children:t.book_status===1?"visibility":"visibility_off"})})}),e.jsx("td",{children:t.view_count||0}),e.jsx("td",{children:t.download_count||0}),e.jsx("td",{children:t.subscriberCount||0}),e.jsxs("td",{children:[e.jsx(h,{to:`/edit/${t.id}`,className:"btn-small waves-effect waves-light tooltipped",style:{marginRight:"5px"},"data-position":"top","data-tooltip":"Edit Book",children:e.jsx("i",{className:"material-icons",children:"edit"})}),e.jsx("button",{className:"btn-small red waves-effect waves-light tooltipped",onClick:()=>y(t.id),"data-position":"top","data-tooltip":"Delete Book",children:e.jsx("i",{className:"material-icons",children:"delete"})}),e.jsx("button",{className:"btn-small yellow darken-2 waves-effect waves-light tooltipped",onClick:()=>v(t.id),"data-position":"top","data-tooltip":t.subscriberCount===0?"No Subscribers to Export":"Export Subscribers",style:{marginLeft:"5px"},disabled:t.subscriberCount===0,children:e.jsx("i",{className:"material-icons",children:"file_download"})})]})]},t.id))})]}),e.jsx("div",{className:"fixed-action-btn",children:e.jsx(h,{to:"/add",className:"btn-floating btn-large blue waves-effect waves-light",children:e.jsx("i",{className:"large material-icons",children:"add"})})})]})};export{$ as default};
