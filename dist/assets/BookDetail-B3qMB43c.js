import{M as r,j as e,A}from"./index-DmeS5GNz.js";import{f as L,u as Y,b as l,L as g}from"./vendor-7WqT3uju.js";import{g as O,i as q,a as P}from"./bookService-Bs2BJIUy.js";import{s as V}from"./email-service-BXjt20yX.js";const p="bookEmail",x="bookEmailExpiry",B=()=>{const o=localStorage.getItem(p),i=localStorage.getItem(x);return!o||!i?null:new Date().getTime()>parseInt(i)?(localStorage.removeItem(p),localStorage.removeItem(x),null):o},U=o=>{const i=new Date().getTime()+864e5;localStorage.setItem(p,o),localStorage.setItem(x,i.toString())},J=()=>{const{slug:o}=L(),i=Y(),[t,f]=l.useState(null),[j,I]=l.useState([]),[m,b]=l.useState(!0),[n,v]=l.useState(""),[d,k]=l.useState(""),[u,N]=l.useState(!1),[y,w]=l.useState(B()),[_,h]=l.useState(!1),E=l.useRef(null);l.useEffect(()=>(o?(async()=>{b(!0);try{const s=await O(o);if(!s||s.book_status===0){r.toast({html:"Book is not available"}),i("/");return}f(s),document.title=`${s.title} - Book Details | Optread`,await q(s.id);const R=(await P()).filter(S=>S.book_status===1&&S.id!==s.id).slice(0,3);I(R)}catch(s){console.error("Error fetching book:",s),r.toast({html:"Error loading book details"}),i("/")}b(!1)})():i("/"),()=>{document.title="Optread"}),[o,i]),l.useEffect(()=>{if(!m&&t){const a=document.querySelector("#downloadModal"),s=r.Modal.init(a,{dismissible:!0,onCloseEnd:()=>{k(""),N(!1)}});return()=>{s&&s.destroy&&s.destroy()}}},[m,t]),l.useEffect(()=>{const a=B();if(a&&v(a),!_){h(!0);const s=document.querySelector("#downloadModal");if(s){const c=r.Modal.getInstance(s);c&&c.open()}}},[]),l.useEffect(()=>{w(null),h(!0)},[o]);const T=()=>{const a=Math.floor(Math.random()*j.length);f(j[a])},D=async a=>{if(a.preventDefault(),!(!d||!n||!u))try{const s=await fetch(`${A}/subscriber`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fullName:d,email:n,bookId:t.id})}),c=await s.json();if(!s.ok)throw new Error(c.message||"Failed to register");U(n),w(n),h(!1),r.Modal.getInstance(E.current).close(),r.toast({html:"Registration successful!"}),i(`/landing/${C(t.title)}`),c.isNew&&await V(n,d,t.title,t.source_url,t.discount_code?t.discount_code:"FREE")}catch(s){r.toast({html:`Error: ${s.message}`})}},F=a=>()=>{navigator.clipboard.writeText(a).then(()=>{r.toast({html:"Coupon code copied to clipboard!"})}).catch(s=>{r.toast({html:"Failed to copy coupon code."})})},M=()=>y?e.jsxs("button",{onClick:()=>i("/landing",{state:{bookSlug:C(t.title)}}),className:"btn btn-large green",children:[e.jsx("i",{className:"material-icons left",children:"download"}),t.book_type==="free"?"View Downloads":"View Discounts"]}):e.jsxs("button",{className:"btn btn-large green modal-trigger","data-target":"downloadModal",children:[e.jsx("i",{className:"material-icons left",children:"download"}),t.book_type==="free"?"Get Free Copy":"Get Discounted Copy"]});return m?e.jsx("div",{className:"container center-align",style:{marginTop:"50px"},children:e.jsx("div",{className:"preloader-wrapper big active",children:e.jsx("div",{className:"spinner-layer spinner-blue-only",children:e.jsx("div",{className:"circle-clipper left",children:e.jsx("div",{className:"circle"})})})})}):t?e.jsxs("div",{className:"container",children:[e.jsx("h3",{className:"center-align",children:o?"Book Details":"Featured Book"}),e.jsxs("div",{className:"card horizontal",style:{marginTop:"30px"},children:[e.jsx("div",{className:"card-image",style:{width:"320px",padding:"20px"},children:e.jsx("img",{src:t.cover||"https://placehold.co/240x320",alt:t.title,style:{width:"100%",height:"auto"}})}),e.jsx("div",{className:"card-stacked",children:e.jsxs("div",{className:"card-content",children:[e.jsx("h4",{children:t.title}),e.jsxs("h5",{children:["By ",t.author]}),e.jsx("div",{className:"divider",style:{margin:"15px 0"}}),t.description.split(`
`).map((a,s)=>e.jsx("p",{children:a},s))||"<p>No description available.</p>",e.jsx("div",{className:"divider",style:{margin:"15px 0"}}),M(),t.book_type==="discount"&&y&&e.jsxs("div",{className:"btn btn-large",style:{marginLeft:"10px"},onClick:F(t.discount_code),title:"Click to Copy Discount Code",children:[e.jsx("i",{className:"material-icons left",children:"local_offer"})," ",t.discount_code]}),e.jsx("div",{className:"row",style:{marginTop:"20px"},children:e.jsxs("div",{className:"col s12",children:[e.jsx("span",{className:"chip teal white-text",children:t.category||"Uncategorized"}),t.tags&&t.tags.split(",").map(a=>e.jsx("span",{className:"chip",children:a.trim()},a))]})})]})})]}),e.jsxs("div",{className:"center-align",style:{marginTop:"40px"},children:[!o&&e.jsxs("button",{onClick:T,className:"btn waves-effect waves-light grey",children:[e.jsx("i",{className:"material-icons left",children:"autorenew"}),"Show Another Book"]}),e.jsxs(g,{to:"/books",className:"btn waves-effect waves-light blue",style:{marginLeft:"10px"},children:[e.jsx("i",{className:"material-icons left",children:"list"}),"Bookshelf"]})]}),e.jsx("div",{id:"downloadModal",className:"modal",ref:E,children:e.jsxs("form",{onSubmit:D,children:[e.jsxs("div",{className:"modal-content",children:[e.jsx("h4",{children:"Enter Your Name & Email to Unlock This Offer!"}),e.jsx("p",{children:"Sign up now to receive book discounts, VIP access to new releases, and exclusive giveaways!"}),e.jsxs("div",{className:"input-field",children:[e.jsx("input",{id:"name",type:"text",value:d,onChange:a=>k(a.target.value),required:!0}),e.jsx("label",{htmlFor:"name",children:"Your Name"})]}),e.jsxs("div",{className:"input-field",children:[e.jsx("input",{id:"email",type:"email",value:n,onChange:a=>v(a.target.value),required:!0}),e.jsx("label",{htmlFor:"email",children:"Your Email"})]}),e.jsx("p",{children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:u,onChange:a=>N(a.target.checked),required:!0}),e.jsxs("span",{children:["I agree to the ",e.jsx(g,{to:"/terms",target:"_blank",children:"Terms of Service"})]})]})})]}),e.jsx("div",{className:"modal-footer",children:e.jsxs("button",{type:"submit",className:"btn waves-effect waves-light green",disabled:!d||!n||!u,children:[e.jsx("i",{className:"material-icons left",children:"check"}),"Verify Email"]})})]})})]}):e.jsx("div",{className:"container center-align",style:{marginTop:"50px"},children:e.jsxs("div",{className:"card-panel blue lighten-5",children:[e.jsx("i",{className:"material-icons large",children:"menu_book"}),e.jsx("h4",{children:"No Books Found"}),e.jsx("p",{children:"Start building your book collection!"}),e.jsxs(g,{to:"/add",className:"btn-large waves-effect waves-light blue",style:{marginTop:"20px"},children:[e.jsx("i",{className:"material-icons left",children:"add"}),"Add Your First Book"]})]})})},C=o=>o.toLowerCase().replace(/[^\w\s]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-");export{J as default};
